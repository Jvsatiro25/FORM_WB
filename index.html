<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Demandas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #ffffff 50%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 42rem;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: none;
            overflow: hidden;
        }

        .card-header {
            text-align: center;
            padding: 2rem 2rem 0;
            margin-bottom: 2rem;
        }

        .icon-circle {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .icon-circle svg {
            width: 2rem;
            height: 2rem;
            color: white;
        }

        .card-title {
            font-size: 1.875rem;
            font-weight: 700;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .card-description {
            font-size: 1.125rem;
            color: #6b7280;
        }

        .card-content {
            padding: 0 2rem 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .form-grid-2, .form-grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .label svg {
            width: 1rem;
            height: 1rem;
            color: #2563eb;
        }

        .input, .textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .input:focus, .textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .textarea {
            resize: none;
            min-height: 6rem;
        }

        .file-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #9ca3af;
        }

        .file-drop-zone.drag-active {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        .file-drop-zone svg {
            width: 3rem;
            height: 3rem;
            color: #9ca3af;
            margin: 0 auto 1rem;
        }

        .file-input {
            display: none;
        }

        .file-button {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #2563eb;
            color: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }

        .file-button:hover {
            background: #1d4ed8;
        }

        .file-list {
            margin-top: 1rem;
            text-align: left;
        }

        .file-list-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .file-item svg {
            width: 1rem;
            height: 1rem;
        }

        .progress-container {
            margin-bottom: 1.5rem;
            display: none;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar-bg {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            width: 0%;
            transition: width 0.3s ease;
        }

        .submit-button {
            width: 100%;
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            transform: scale(1);
        }

        .submit-button:hover:not(:disabled) {
            transform: scale(1.02);
            background: linear-gradient(135deg, #1d4ed8, #4338ca);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .file-hint {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <div class="icon-circle">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h1 class="card-title">Formulário de Demandas</h1>
                <p class="card-description">Preencha os dados abaixo para criar uma nova demanda</p>
            </div>

            <div class="card-content">
                <form id="formulario" class="form-grid">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="assessor" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Assessor
                            </label>
                            <input type="text" id="assessor" name="assessor" class="input" placeholder="Nome do assessor" required>
                        </div>

                        <div class="form-group">
                            <label for="data" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Data
                            </label>
                            <input type="date" id="data" name="data" class="input" required>
                        </div>
                    </div>

                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="nome" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                Nome
                            </label>
                            <input type="text" id="nome" name="nome" class="input" placeholder="Nome completo" required>
                        </div>

                        <div class="form-group">
                            <label for="contato" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                Contato
                            </label>
                            <input type="text" id="contato" name="contato" class="input" placeholder="Telefone ou email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="oficio" class="label">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 01-2 2H10a2 2 0 01-2-2V6m8 0V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2"></path>
                            </svg>
                            Ofício
                        </label>
                        <input type="text" id="oficio" name="oficio" class="input" placeholder="Ex: Pastor, Líder Comunitário ou Morador" required>
                    </div>

                    <!-- Separando endereço em três campos: bairro, rua e número -->
                    <div class="form-group">
                        <label for="rua" class="label">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Rua
                        </label>
                        <input type="text" id="rua" name="rua" class="input" placeholder="Ex: Rua do Imperador" required>
                    </div>

                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="bairro" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                Bairro
                            </label>
                            <input type="text" id="bairro" name="bairro" class="input" placeholder="Ex: Centro" required>
                        </div>

                        <div class="form-group">
                            <label for="numero" class="label">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                                </svg>
                                Número
                            </label>
                            <input type="text" id="numero" name="numero" class="input" placeholder="123" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="assunto" class="label">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Assunto
                        </label>
                        <textarea id="assunto" name="assunto" class="textarea" placeholder="Descreva o assunto detalhadamente..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="label">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Anexar Arquivos
                        </label>
                        <div class="file-drop-zone" id="dropZone">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p style="color: #6b7280; margin-bottom: 0.5rem;">Arraste e solte seus arquivos aqui ou</p>
                            <input type="file" id="arquivo" name="arquivo" class="file-input" accept="image/*,video/*" multiple>
                            <label for="arquivo" class="file-button">Selecionar Arquivos</label>
                            <p class="file-hint">Apenas imagens e vídeos são permitidos</p>
                            <div id="fileList" class="file-list" style="display: none;">
                                <p class="file-list-title">Arquivos selecionados:</p>
                                <div id="fileItems"></div>
                            </div>
                        </div>
                    </div>

                    <div id="progressContainer" class="progress-container">
                        <div class="progress-header">
                            <span>Enviando...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                    </div>

                    <button type="submit" id="submitButton" class="submit-button">
                        Concluir Registro
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";

// Configuração Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDiC4oMxGofdMXSqQbf6mHua0dLafYrdlU",
    authDomain: "formulario-27b90.firebaseapp.com",
    projectId: "formulario-27b90",
    storageBucket: "formulario-27b90.firebasestorage.app",
    messagingSenderId: "540452486205",
    appId: "1:540452486205:web:e6c49369e7578a54863e54",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Função de upload com progresso
function uploadArquivoComProgresso(file, index, total, onProgress) {
    return new Promise((resolve, reject) => {
        const nomeArquivo = Date.now() + "-" + file.name;
        const storageRef = ref(storage, "FORM_WB /" + nomeArquivo);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on("state_changed",
            (snapshot) => {
                const progressoTotal = ((index + snapshot.bytesTransferred / snapshot.totalBytes) / total) * 100;
                onProgress(progressoTotal.toFixed(0));
            },
            (error) => {
                reject(error);
            },
            async () => {
                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                resolve(downloadURL);
            }
        );
    });
}

// Referências HTML
const form = document.getElementById("formulario");
const fileInput = document.getElementById("arquivo");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const progressPercent = document.getElementById("progressPercent");
const fileList = document.getElementById("fileList");
const fileItems = document.getElementById("fileItems");
const dropZone = document.getElementById("dropZone");

// Lista de arquivos acumulados
let arquivosSelecionados = [];

// Função para atualizar a lista e a contagem
function atualizarFileList() {
    fileItems.innerHTML = "";
    if (arquivosSelecionados.length === 0) {
        fileList.style.display = "none";
    } else {
        fileList.style.display = "block";
        arquivosSelecionados.forEach(file => {
            const item = document.createElement("div");
            item.classList.add("file-item");
            item.innerHTML = `
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M4 12l8-8 8 8M12 4v12"/>
                </svg>
                ${file.name}
            `;
            fileItems.appendChild(item);
        });

        const titulo = fileList.querySelector(".file-list-title");
        titulo.textContent = arquivosSelecionados.length === 1 
            ? "1 arquivo selecionado" 
            : `${arquivosSelecionados.length} arquivos selecionados`;
    }
}

// Seleção via input
fileInput.addEventListener("change", () => {
    arquivosSelecionados = [...arquivosSelecionados, ...Array.from(fileInput.files)];
    atualizarFileList();
});

// Drag & Drop completo
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("drag-active");
});

dropZone.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag-active");
});

dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("drag-active");

    const arquivosArrastados = Array.from(e.dataTransfer.files);
    const arquivosValidos = arquivosArrastados.filter(file => 
        file.type.startsWith("image/") || file.type.startsWith("video/")
    );

    if (arquivosValidos.length < arquivosArrastados.length) {
        alert("Apenas arquivos de imagem ou vídeo são permitidos.");
    }

    arquivosSelecionados = [...arquivosSelecionados, ...arquivosValidos];
    atualizarFileList();
});

// Envio do formulário
form.addEventListener("submit", async (event) => {
    event.preventDefault();

    const assessor = document.getElementById("assessor").value.toUpperCase();
    const data = document.getElementById("data").value;
    const nome = document.getElementById("nome").value;
    const contato = document.getElementById("contato").value;
    const oficio = document.getElementById("oficio").value;
    const rua = document.getElementById("rua").value;
    const bairro = document.getElementById("bairro").value;
    const numero = document.getElementById("numero").value;
    const assunto = document.getElementById("assunto").value;

    let arquivosURLs = [];

    if (arquivosSelecionados.length > 0) {
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";
        progressPercent.textContent = "0%";

        for (let i = 0; i < arquivosSelecionados.length; i++) {
            const file = arquivosSelecionados[i];
            if (!file.type.startsWith("image/") && !file.type.startsWith("video/")) {
                alert("Apenas arquivos de imagem ou vídeo são permitidos.");
                return;
            }

            const url = await uploadArquivoComProgresso(file, i, arquivosSelecionados.length, (percent) => {
                progressBar.style.width = percent + "%";
                progressPercent.textContent = percent + "%";
            });

            if (url) {
                arquivosURLs.push({
                    url: url,
                    tipo: file.type.startsWith("image/") ? "imagem" : "video"
                });
            }
        }
    }

    try {
        await addDoc(collection(db, "FORM_WB "/*espaço*/), {
            assessor,
            data,
            nome,
            contato,
            oficio,
            rua,
            bairro,
            numero,
            assunto,
            arquivosURLs,
            timestamp: serverTimestamp()
        });

        alert("Registro salvo com sucesso!");
        form.reset();
        arquivosSelecionados = [];
        atualizarFileList();
        progressContainer.style.display = "none";
        progressBar.style.width = "0%";
        progressPercent.textContent = "0%";
    } catch (error) {
        console.error("Erro ao salvar:", error);
        alert("Erro ao salvar os dados.");
        progressContainer.style.display = "none";
    }
});
</script>


</body>
</html>
